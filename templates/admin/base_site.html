{% extends "admin/base.html" %}
{% load static %}

{% block title %}{{ title }} | NAG Admin{% endblock %}
<script defer>
// Fallback mover: run inline to ensure action even if external JS didn't load
document.addEventListener('DOMContentLoaded', function () {
    try {
        var existing = document.getElementById('moved-admin-logo');
        if (existing) return; // already moved

        var sidebarLogo = document.querySelector('.main-sidebar .brand-link img, .sidebar .brand-link img, img.nag-logo, img[alt*="Logo"], img[src*="logo.png"]');

        var headerProfile = document.querySelector('#user-tools, .user-tools, .navbar-right, .navbar-nav') || document.querySelector('#header') || document.body;

        function insertLogo(imgSrc) {
            try {
                var headerProfileLocal = headerProfile || document.querySelector('#header') || document.body;
                var container = document.createElement('div');
                container.id = 'moved-logo-container-inline';
                container.style.display = 'flex'; container.style.alignItems = 'center'; container.style.marginLeft = '8px';
                var img = document.createElement('img');
                img.id = 'moved-admin-logo';
                img.src = imgSrc;
                img.style.height = '32px'; img.style.width = 'auto'; img.style.display = 'block'; img.style.visibility = 'visible'; img.style.opacity = '1';
                img.style.objectFit = 'contain';
                img.alt = 'NAG Logo';
                var a = document.createElement('a'); a.href = '/admin/'; a.style.display = 'inline-flex'; a.appendChild(img);
                container.appendChild(a);

                if (headerProfileLocal.tagName === 'UL' || (headerProfileLocal.classList && headerProfileLocal.classList.contains('navbar-nav'))) {
                    var li = document.createElement('li'); li.style.display='flex'; li.appendChild(container); headerProfileLocal.appendChild(li);
                } else {
                    headerProfileLocal.appendChild(container);
                }

                console.debug('inline logo mover: inserted new img');
            } catch (e) { console.error('insertLogo error', e); }
        }

        if (sidebarLogo) {
            // try to clone/move
            try {
                var headerProfileLocal = headerProfile || document.querySelector('#header') || document.body;
                var container = document.createElement('div');
                container.id = 'moved-logo-container-inline';
                container.style.display = 'flex'; container.style.alignItems = 'center'; container.style.marginLeft = '8px';
                var clone = sidebarLogo.cloneNode(true);
                clone.id = 'moved-admin-logo';
                clone.style.height = '32px'; clone.style.width = 'auto'; clone.style.display = 'block'; clone.style.visibility = 'visible'; clone.style.opacity = '1';
                clone.style.objectFit = 'contain';
                var a = document.createElement('a'); a.href = '/admin/'; a.style.display = 'inline-flex'; a.appendChild(clone);
                container.appendChild(a);

                if (headerProfileLocal.tagName === 'UL' || (headerProfileLocal.classList && headerProfileLocal.classList.contains('navbar-nav'))) {
                    var li = document.createElement('li'); li.style.display='flex'; li.appendChild(container); headerProfileLocal.appendChild(li);
                } else {
                    headerProfileLocal.appendChild(container);
                }

                // remove original if inside a sidebar
                try { var root = sidebarLogo.closest('.main-sidebar, .sidebar, aside'); if (root) sidebarLogo.parentElement.removeChild(sidebarLogo); } catch(e){}
                console.debug('inline logo mover: moved clone');
                return;
            } catch (e) {
                console.error('clone/move error', e);
            }
        }

        // If we reach here, no sidebarLogo or clone failed â€” create from static path
        try {
            var src = "{% static 'admin/img/logo.png' %}";
            insertLogo(src);
        } catch (e) {
            console.error('fallback create error', e);
        }

    } catch(e) { console.error('inline mover error', e); }
});
</script>

{% block branding %}
<h1 id="site-name" style="display: none !important;">
    <a href="{% url 'admin:index' %}"></a>
</h1>
<div class="nag-logo-container">
    <a href="{% url 'admin:index' %}">
        <img src="{% static 'admin/img/logo.png' %}" alt="NAG Logo" class="nag-logo"
             style="display: block !important; height: 35px !important; width: auto !important; visibility: visible !important; opacity: 1 !important;">
    </a>
</div>
{% endblock %}

{% block extrahead %}
{{ block.super }}
<script src="{% static 'admin/js/logo-move.js' %}" defer></script>
<script defer>
// Fallback mover: run inline to ensure action even if external JS didn't load
document.addEventListener('DOMContentLoaded', function () {
    try {
        var existing = document.getElementById('moved-admin-logo');
        if (existing) return; // already moved
        var sidebarLogo = document.querySelector('.main-sidebar .brand-link img, .sidebar .brand-link img, img.nag-logo, img[alt*="Logo"], img[src*="logo.png"]');
        if (!sidebarLogo) {
            console.debug('inline logo mover: no sidebar logo found');
            return;
        }
        var headerProfile = document.querySelector('#user-tools, .user-tools, .navbar-right, .navbar-nav') || document.querySelector('#header') || document.body;
        var container = document.createElement('div');
        container.id = 'moved-logo-container-inline';
        container.style.display = 'flex'; container.style.alignItems = 'center'; container.style.marginLeft = '8px';
        var clone = sidebarLogo.cloneNode(true);
        clone.id = 'moved-admin-logo';
        clone.style.height = '32px'; clone.style.width = 'auto'; clone.style.display = 'block'; clone.style.visibility = 'visible'; clone.style.opacity = '1';
        var a = document.createElement('a'); a.href = ''; a.style.display = 'inline-flex'; a.appendChild(clone);
        container.appendChild(a);
        // insert into headerProfile if possible
        if (headerProfile.tagName === 'UL' || headerProfile.classList.contains('navbar-nav')) {
            var li = document.createElement('li'); li.style.display='flex'; li.appendChild(container); headerProfile.appendChild(li);
        } else {
            headerProfile.appendChild(container);
        }
        // remove original
        try { var root = sidebarLogo.closest('.main-sidebar, .sidebar, aside'); if (root) sidebarLogo.parentElement.removeChild(sidebarLogo); } catch(e){}
        console.debug('inline logo mover: moved');
    } catch(e) { console.error('inline mover error', e); }
});
</script>
<script defer>
// Replace displayed user email with full name in Jazzmin sidebar / user panels
document.addEventListener('DOMContentLoaded', function () {
    try {
        var first = '{{ request.user.first_name|escapejs }}';
        var last = '{{ request.user.last_name|escapejs }}';
        var full = [first, last].filter(Boolean).join(' ');
        var email = '{{ request.user.email|escapejs }}';
        if (!full) { full = email; }

        // Prefer specific user-panel selectors used by admin themes
        var selectors = [
            '.user-panel .info',
            '.user-panel .info p',
            '.user-panel .info a',
            '.user-panel a',
            '#user-tools',
            '.user-tools',
            '.navbar-nav .user',
            '.navbar-nav .dropdown-toggle',
            '.nav-user',
            '.top-nav .user',
        ];

        // First, try to replace any exact email occurrences in the DOM
        if (email) {
            var nodes = document.querySelectorAll('body *');
            for (var i = 0; i < nodes.length; i++) {
                var node = nodes[i];
                try {
                    if (node.childElementCount === 0 && node.textContent && node.textContent.indexOf(email) !== -1) {
                        node.textContent = node.textContent.replace(email, full);
                        try { node.style.color = '#fff'; } catch (e) {}
                    }
                } catch (e) {}
            }
        }

        // Also try targeted selectors to set the text directly
        for (var s = 0; s < selectors.length; s++) {
            var el = document.querySelector(selectors[s]);
            if (el) {
                // If element contains multiple nodes, try to find a text node or anchor
                if (el.tagName === 'A' || el.tagName === 'P' || el.tagName === 'SPAN' || el.tagName === 'DIV') {
                    el.textContent = full;
                    try { el.style.color = '#fff'; } catch (e) {}
                } else {
                    // find a child text-bearing element
                    var child = el.querySelector('a, p, span');
                    if (child) {
                        child.textContent = full;
                        try { child.style.color = '#fff'; } catch (e) {}
                    }
                }
                break;
            }
        }
    } catch (e) {
        console.error('replace-user-name error', e);
    }
});
</script>
{% endblock %}

{% block nav-global %}{% endblock %}